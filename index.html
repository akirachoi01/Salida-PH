<script>
  const API_KEY = 'ba3885a53bc2c4f3c4b5bdc1237e69a0';
  const IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';
  const categories = [
    { id: 'trending', label: 'Trending' },
    { id: 'popular', label: 'Popular' },
    { id: 'top_rated', label: 'Top Rated' },
    { id: 'upcoming', label: 'Upcoming' }
  ];

  const tabsEl = document.getElementById('categoryTabs');
  const recList = document.getElementById('recommendationList');
  const player = document.getElementById('player');
  const searchInput = document.getElementById('searchInput');

  categories.forEach((cat, idx) => {
    const btn = document.createElement('button');
    btn.textContent = cat.label;
    btn.onclick = () => loadCategory(cat.id, idx);
    tabsEl.appendChild(btn);
  });

  async function loadCategory(catId, idx) {
    const path = catId === 'trending' ? 'trending/all/week' : `movie/${catId}`;
    const res = await fetch(`https://api.themoviedb.org/3/${path}?api_key=${API_KEY}&language=en-US`);
    const data = await res.json();
    showRecommendations(data.results);
    document.querySelectorAll('#categoryTabs button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('#categoryTabs button')[idx].classList.add('active');
  }

  function showRecommendations(arr) {
    recList.innerHTML = '<h2>Recommended</h2>';
    arr.forEach(item => {
      const isMovie = item.media_type !== 'tv';
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${IMAGE_BASE}${item.backdrop_path || item.poster_path}" alt="">
        <div class="info">
          <div class="title">${item.title || item.name}</div>
          <div class="meta">⭐ ${item.vote_average?.toFixed(1) || '0'} • ${(item.release_date || item.first_air_date || '').split('-')[0]}</div>
        </div>`;
      card.onclick = () => {
        player.src = isMovie
          ? \`https://player.videasy.net/movie/${item.id}\`
          : \`https://player.videasy.net/tv/${item.id}/1/1?autoplayNextEpisode=true\`;
      };
      recList.appendChild(card);
    });
  }

  searchInput.addEventListener('input', async () => {
    const q = searchInput.value.trim();
    if (q.length < 2) return loadCategory('trending', 0);
    const res = await fetch(\`https://api.themoviedb.org/3/search/multi?api_key=\${API_KEY}&query=\${encodeURIComponent(q)}&include_adult=false\`);
    const data = await res.json();
    showRecommendations(data.results);
  });

  // Correct window message listener
  window.addEventListener("message", function (event) {
    if (typeof event.data === "string") {
      const messageArea = document.querySelector("#messageArea");
      if (messageArea) {
        messageArea.innerText = event.data;
      }
    }
  });

  // Initial Load
  loadCategory('trending', 0);
</script>
